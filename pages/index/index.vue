<template>
	<view class="ux-bg-primary" style="height:Â  var(--status-bar-height);">&nbsp;</view>
	<view class="ux-padding ux-bg-grey5" style="min-height: 100vh;">
		<view class="ux-flex ux-space-between ux-align-items-center">
			<view>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</view>
			<image class="ux-mb-small" src="/static/index-logo.png" mode="widthFix" style="width:250rpx;"></image>
			<view hover-class="ux-tap">
				<navigator class="ux-border-radius" url="/pages/about/about">
					<text class="icon section-icon ux-pt-small">&#xe5d4;</text>
				</navigator>
			</view>
		</view>
		<br>
		<text class="ux-pl-small ux-opacity-6 ux-text-small">{{this.title}}</text>
		<view class="ux-border-radius-large notice">
			<view class="left">
				<text class="icon ux-color-primary">&#xe0b9;</text>
				<text class="text">&nbsp;å…¬å‘Š</text>
			</view>
			<view class="center">
				<swiper vertical autoplay interval="2500" duration="300" circular>
					<swiper-item v-for="(item, index) in items" :key="index" style="font-size: 24rpx;"
						class="ux-pl-small ux-opacity-8">
						{{ item }}
					</swiper-item>
				</swiper>
			</view>
		</view>

		<view class="ux-mt-small ux-flex1">
			<view class="ux-flex ux-rows ux-wrap ux-space-between">
				<navigator class="ux-th ux-bg-white ux-border-radius-large ux-padding ux-mr-small"
					style="flex:auto;width:1rpx;" hover-class="ux-tap" url="/pages/train/query">
					<text class="icon section-icon ux-color-purple">&#xe192;</text>
					<br>
					<text class="ux-text">è½¦æ¬¡</text>
					<br>
					<text class="ux-text-small ux-opacity-8">æŸ¥è¯¢æ—¶åˆ»ã€å¼€è¡Œæ—¥ç­‰ä¿¡æ¯ã€‚</text>
					<br>
					<br>
					<view class="ux-text-right ux-mr-small">
						<text class="icon">&#xe5c8;</text>
					</view>
				</navigator>
				<navigator class="ux-th ux-bg-white ux-border-radius-large ux-padding ux-ml-small"
					style="flex:auto;width:1rpx;" hover-class="ux-tap" url="/pages/station/query">
					<text class="icon section-icon ux-color-cyan1">&#xe88a;</text>
					<br>
					<text class="ux-text">è½¦ç«™</text>
					<br>
					<text class="ux-text-small ux-opacity-8">æŸ¥è¯¢é€šè¿‡è½¦æ¬¡ã€çº¿è·¯ç­‰ä¿¡æ¯ã€‚</text>
					<br>
					<br>
					<view class="ux-text-right ux-mr-small">
						<text class="icon">&#xe5c8;</text>
					</view>
				</navigator>
			</view>
			<br>
			<view class="ux-flex ux-rows ux-wrap ux-space-between">		
				<navigator class="ux-th ux-bg-white ux-border-radius-large ux-padding ux-mr-small"
					style="flex:auto;width:1rpx;" hover-class="ux-tap" url="/pages/speed/speed">
					<text class="icon section-icon ux-color-brown">&#xe55e;</text>
					<br>
					<text class="ux-text">å®æ—¶æµ‹é€Ÿ</text>
					<br>
					<text class="ux-text-small ux-opacity-8">å®æ—¶ä½¿ç”¨GPSè¿›è¡Œé€Ÿåº¦æµ‹è¯•ã€‚</text>
					<br>
					<br>
					<view class="ux-text-right ux-mr-small">
						<text class="icon">&#xe5c8;</text>
					</view>
				</navigator>
				<view class="ux-th ux-bg-white ux-border-radius-large ux-padding ux-ml-small"
					style="flex:auto;width:1rpx;">
					<text class="icon section-icon ux-color-blue">&#xe1b7;</text>
					<br>
					<text class="ux-text">é›·è¾¾</text>
					<br>
					<text class="ux-text-small ux-opacity-8">å®æ—¶é¢„æµ‹é™„è¿‘ç»è¿‡çš„åˆ—è½¦ã€‚</text>
					<br>
					<br>
					<view class="ux-text-right ux-mr-small">
						</view>
					<text class="ux-text-small">æ–½å·¥ä¸­ è¯·é™å€™ä½³éŸ³</text>
				</view>
			</view><br>
			<view class="ux-flex ux-rows ux-wrap ux-space-between">
				<navigator class="ux-th ux-bg-white ux-border-radius-large ux-padding"
					style="flex:auto;width:1rpx;" hover-class="ux-tap" url="/pages/emu/query">
					<text class="icon section-icon ux-color-orange1">&#xe570;</text>
					<br>
					<text class="ux-text">åŠ¨è½¦ç»„</text>
					<br>
					<text class="ux-text-small ux-opacity-8">æŸ¥è¯¢åŠ¨è½¦ç»„é…å±å’Œè¿è¡Œäº¤è·¯ã€‚</text>
					<br>
					<br>
					<view class="ux-text-right ux-mr-small">
						<text class="icon">&#xe5c8;</text>
					</view>
				</navigator>
			</view>
		</view>
		<br>
		<swiper v-if="bannerImages.length > 0" class="ux-border-radius-large" :style="{height: swiperHeight}" indicator-dots circular autoplay>
			<swiper-item v-for="(url, index) in bannerImages" :key="index">
				<image :src="url" mode="widthFix" class="ux-border-radius-large" style="width: 100%;" @load="onImageLoad"></image>
			</swiper-item>
		</swiper>
		<image v-else class="ux-border-radius-large" src="/static/overlay/index_banner_1.png" style="width:100%;" mode="widthFix"></image>
	</view>
	
	<!-- æ›´æ–°æ¬¢è¿å¼¹çª— -->
	<view v-if="showUpdatePopup" class="update-popup-overlay" @click="closeUpdatePopup">
		<view class="update-popup" @click.stop="() => {}">
			<view class="update-popup-content">
				<text class="update-popup-title">ğŸ‰ æ¬¢è¿ä½¿ç”¨æ–°ç‰ˆæœ¬</text>
				<text class="update-popup-message">æ¬¢è¿æ¥åˆ° RailGo {{ updateVersion }} ç‰ˆæœ¬<br>å¯å»æ›´æ–°æ—¥å¿—çœ‹çœ‹å“¦ï¼</text>
			</view>
		</view>
	</view>
</template>

<script>
	// å¯¼å…¥æœ¬åœ° JSON æ–‡ä»¶
	import hitokotoData from '@/static/i.json';

	async function check() {
		if (uni.getStorageSync("jqok")) {
			return
		}
		try {
			const Response = await uniGet("https://center.zenglingkun.cn/beta/api/check/" + uni.getStorageSync(
				'version') + "?userid=" + uni.getStorageSync('qq') + "&key=" + uni.getStorageSync('key'));
			if (Response.data.valid) {
				uni.setStorageSync("AuthTime", new Date().getTime())
				console.log("é‰´æƒæˆåŠŸ")
				uni.showToast({
					title: 'é‰´æƒæˆåŠŸ',
					position: 'bottom',
				})
				uni.setStorage({
					key: 'jqok',
					data: true
				});
			} else {
				uni.showToast({
					title: 'é‰´æƒæ— æ•ˆ',
					position: 'bottom',
				})
				uni.setStorageSync("oobe", false)
				uni.reLaunch({
					url: '/pages/oobe/welcome'
				})
			}

		} catch (error) {
			if (checkTime(uni.getStorageSync("AuthTime"), new Date().getTime())) {
				uni.showToast({
					title: 'é‰´æƒè¶…æ—¶ï¼Œè¯·é‡æ–°é‰´æƒ',
					position: 'bottom',
				})
				uni.setStorageSync("oobe", false)
				uni.reLaunch({
					url: '/pages/oobe/welcome'
				})
			} else {
				console.log("æ— ç½‘ç»œä½†æœªè¶…æ—¶")
				uni.showToast({
					title: 'ç¦»çº¿é‰´æƒæˆåŠŸ',
					position: 'bottom',
				})
			}
		}
	}
import {uniGet} from "@/scripts/req.js";
	import {
		loadDB
	} from "@/scripts/sqlite.js";
	import {
		doQuery,
	} from "@/scripts/sqlite.js";
	import {
		KEYS_STRUCT_STATIONS,
		KEYS_STRUCT_TRAINS
	} from "@/scripts/config.js";
	export default {
		// Railgo Code
		data() {
			return {
				title: 'æµ·å†…å­˜çŸ¥å·±ï¼Œå¤©æ¶¯è‹¥æ¯”é‚»ã€‚', // é»˜è®¤å€¼
				visit: 0,
				query: 0,
				items: ['æš‚æ— å…¬å‘Š'],
				bannerImages: [],
				swiperHeight: '210rpx', // Initialize with a default height
				showUpdatePopup: false,
				updateVersion: ''
			};
		},
		mounted() {
			this.setHitokoto();
			this.fetchRemoteData();
		},
		onShow() {
			// #ifdef APP
			plus.navigator.setStatusBarBackground('#114598');
			plus.navigator.setFullscreen(false);
			plus.navigator.showSystemNavigation();
			// #endif
			// é‰´æƒ
			if (uni.getStorageSync("NeedAuth")) {
				check()
			}
			
			const navigateToUpdates = uni.getStorageSync('navigateToUpdates');
			if (navigateToUpdates) {
				uni.removeStorageSync('navigateToUpdates'); 
				setTimeout(() => {
					uni.navigateTo({
						url: '/pages/about/UpdateInfo'
					});
				}, 300);
			}
			
			// æ£€æŸ¥æ˜¯å¦éœ€è¦æ˜¾ç¤ºæ›´æ–°æ¬¢è¿å¼¹çª—
			const customPopupData = uni.getStorageSync('showCustomUpdatePopup');
			if (customPopupData && customPopupData.show) {
				uni.removeStorageSync('showCustomUpdatePopup'); // æ¸…é™¤æ ‡è®°
				this.showUpdatePopup = true;
				this.updateVersion = customPopupData.version;
			}
		},
		methods: {
			setHitokoto() {
				const maxAttempts = 20;
				for (let i = 0; i < maxAttempts; i++) {
					const randomIndex = Math.floor(Math.random() * hitokotoData.length);
					const hitokoto = hitokotoData[randomIndex].hitokoto;

					if (hitokoto.length <= 18) {
						this.title = hitokoto;
						return;
					}
				}
				this.title = 'æµ·å†…å­˜çŸ¥å·±ï¼Œå¤©æ¶¯è‹¥æ¯”é‚»ã€‚';
			},

			async fetchRemoteData() {
				try {
					const statsResponse = await uniGet('https://api.state.railgo.zenglingkun.cn/state');
					this.visit = statsResponse.data.visits;
					this.query = statsResponse.data.queries;

					const noticeResponse = await uniGet("https://api.state.railgo.zenglingkun.cn/notice");
					this.items = noticeResponse.data;

					const picResponse = await uniGet("https://api.state.railgo.zenglingkun.cn/pic");
					this.bannerImages = picResponse.data;

					await uniGet("https://api.state.railgo.zenglingkun.cn/visit");
				} catch (error) {
					console.error('Error fetching remote data:', error);
					this.visit = 0;
					this.query = 0;
					this.items = ['æš‚æ— å…¬å‘Š'];
					this.bannerImages = [];
				}
			},
			onImageLoad(e) {
				// We only need to set the height once for the first image
				if (this.swiperHeight === '210rpx' && this.bannerImages.length > 0) {
					const {
						width,
						height
					} = e.detail;
					const screenWidth = uni.getSystemInfoSync().windowWidth;
					const newHeight = (screenWidth * height) / width;
					this.swiperHeight = `${newHeight}px`;
				}
			},
			
			closeUpdatePopup() {
				this.showUpdatePopup = false;
			},
			
			goToUpdateLog() {
				this.showUpdatePopup = false;
				uni.navigateTo({
					url: '/pages/about/UpdateInfo'
				});
			}
		}
	};
</script>

<style lang="scss">
	.section-icon {
		font-size: 50rpx;
	}

	.main {
		.box {
			background: #ffffff;
			box-sizing: border-box;
			font-family: "é’‰é’‰è¿›æ­¥ä½“";
			overflow: hidden;

			.desc {
				margin-left: 23px;
				font-size: 14px;
				position: absolute;
				margin-top: -5px;
			}

			.data {
				margin-left: 23px;
				font-size: 13px;
				position: absolute;
				margin-top: 13px;
				color: gray
			}
		}
	}

	.notice {
		width: 100%;
		height: 80rpx;
		line-height: 80rpx;
		background: #f9f9f9;
		margin: 0 auto;
		margin-top: 10px;
		display: flex;

		.left {
			width: 140rpx;
			display: flex;
			align-items: center;
			justify-content: center;

			.text {
				color: #114598;
				font-weight: 600;
				font-size: 28rpx;
			}
		}

		.center {
			flex: 1;

			swiper {
				height: 100%;

				&-item {
					height: 100%;
					font-size: 30rpx;
					color: #666;
					overflow: hidden;
					white-space: nowrap;
					text-overflow: ellipsis;
				}
			}
		}

		.right {
			width: 70rpx;
			display: flex;
			align-items: center;
			justify-content: center;
		}
	}
	
	/* æ›´æ–°æ¬¢è¿å¼¹çª—æ ·å¼ */
	.update-popup-overlay {
		position: fixed;
		top: 0;
		left: 0;
		width: 100%;
		height: 100%;
		background-color: rgba(0, 0, 0, 0.5);
		display: flex;
		justify-content: center;
		align-items: center;
		z-index: 9999;
	}
	
	.update-popup {
		width: 80%;
		max-width: 500rpx;
		background: #fff;
		border-radius: 20rpx;
		overflow: hidden;
		animation: popupScaleIn 0.3s ease-out;
	}
	
	@keyframes popupScaleIn {
		0% {
			transform: scale(0.7);
			opacity: 0;
		}
		100% {
			transform: scale(1);
			opacity: 1;
		}
	}
	
	.update-popup-content {
		padding: 40rpx;
		text-align: center;
	}
	
	.update-popup-header {
		margin-bottom: 20rpx;
	}
	
	.update-popup-title {
		font-size: 36rpx;
		font-weight: bold;
		color: #114598;
		display: block;
	}
	
	.update-popup-body {
		margin: 30rpx 0;
	}
	.update-popup-message {
		font-size: 28rpx;
		color: #333;
		line-height: 1.5;
	}
</style>